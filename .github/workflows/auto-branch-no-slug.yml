name: Auto branch from issue (no slug)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

concurrency:
  group: issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  create:
    if: github.event.label.name == 'create-branch'
    runs-on: ubuntu-latest
    steps:
      - name: Create branch from issue (no slug)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;
            const base = context.payload.repository.default_branch; // main/develop и т.п.
            const branch = `issue/${issue.number}`;

            const baseRef = await github.rest.git.getRef({ owner, repo, ref: `heads/${base}` });
            const sha = baseRef.data.object.sha;

            let created = false;
            try {
              await github.rest.git.createRef({ owner, repo, ref: `refs/heads/${branch}`, sha });
              created = true;
            } catch (e) {
              if (e.status !== 422) throw e; // 422 — ветка уже есть
            }

            const url = `https://github.com/${owner}/${repo}/tree/${branch}`;
            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: created
                ? `Создал ветку \`${branch}\` от \`${base}\`. [Перейти](${url})`
                : `Ветка \`${branch}\` уже существует. [Перейти](${url})`
            });
